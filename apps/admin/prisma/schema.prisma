// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Source-of-Truth Models as specified in requirements
model SEOEntry {
  id          String   @id @default(cuid())
  url         String   @unique
  title       String?
  description String?
  keywords    String[]
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("seo_entries")
}

// Phase 6.5: Enhanced Media Asset for rich media library
model MediaAsset {
  id              String      @id @default(cuid())
  filename        String      // Unique filename in storage
  originalName    String      // Original uploaded filename
  url             String      // Public URL from Supabase Storage
  thumbnailUrl    String?     // Optimized thumbnail URL
  mimeType        String      // MIME type (image/jpeg, video/mp4, etc.)
  size            Int         // File size in bytes
  
  // Image/Video metadata
  width           Int?        // Width in pixels (for images/videos)
  height          Int?        // Height in pixels (for images/videos)
  duration        Int?        // Duration in seconds (for videos)
  
  // Content metadata
  alt             String?     // Alt text for accessibility
  caption         String?     // Caption/description
  
  // Organization
  folder          String?     // Folder/category (e.g., "blog", "avatars")
  tags            String[]    // Searchable tags
  
  // Ownership & RBAC
  uploadedBy      String
  uploader        User        @relation("UploadedMedia", fields: [uploadedBy], references: [id])
  
  // Status
  status          String      @default("ACTIVE") // ACTIVE, ARCHIVED, DELETED
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  PostMedia           PostMedia[]
  featuredInPosts     Post[]        @relation("FeaturedImage")
  featuredInCaseStudies CaseStudy[] @relation("CaseStudyFeaturedImage")  // Phase 1

  @@index([uploadedBy])
  @@index([folder])
  @@index([mimeType])
  @@index([status])
  @@map("media_assets")
}

model PostMedia {
  id           String     @id @default(cuid())
  postId       String
  mediaAssetId String
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@unique([postId, mediaAssetId])
  @@map("post_media")
}

// Phase 7: AI Content Generation Models

enum AIModel {
  GPT4
  GPT4_TURBO
  CLAUDE3_OPUS
  CLAUDE3_SONNET
  CLAUDE3_HAIKU
  GEMINI_PRO
}

enum AIGenerationType {
  CONTENT_DRAFT      // Full article generation
  CONTENT_OUTLINE    // Article outline
  CONTENT_IDEAS      // Content ideas/topics
  TRANSLATION        // EN â†’ AR translation
  SEO_METADATA       // Title, description, keywords
  CONTENT_IMPROVE    // Enhance existing content
  URL_EXTRACTION     // Extract content from URL
}

model AIArtifact {
  id          String   @id @default(cuid())
  type        String   // "outline_options", "outline_final", "facts", "content", etc.
  content     Json
  metadata    Json?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy  String?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  postId      String?  // Link to associated post
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_artifacts")
}

// Phase 7: AI Content Generation tracking
model AIGeneration {
  id              String            @id @default(cuid())
  
  // Generation details
  type            AIGenerationType
  model           AIModel           @default(GPT4_TURBO)
  prompt          String            @db.Text
  systemPrompt    String?           @db.Text
  
  // Input/Output
  input           Json?             // Input data (URL, text, etc.)
  output          String?           @db.Text // Generated content
  
  // Metadata
  tokensUsed      Int?
  costEstimate    Float?            // in USD
  duration        Int?              // in milliseconds
  
  // Status
  status          String            @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  error           String?           @db.Text
  
  // Relations
  userId          String
  user            User              @relation("UserGenerations", fields: [userId], references: [id])
  postId          String?
  post            Post?             @relation("PostGenerations", fields: [postId], references: [id])
  linkedInPosts   LinkedInPost[]    @relation("LinkedInPostGeneration")
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  completedAt     DateTime?
  
  @@index([userId])
  @@index([postId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("ai_generations")
}

// Phase 7: URL Content Extraction history
model URLExtraction {
  id              String      @id @default(cuid())
  url             String
  
  // Extracted content
  title           String?
  author          String?
  publishedDate   DateTime?
  content         String?     @db.Text
  excerpt         String?
  imageUrl        String?
  
  // Metadata
  siteName        String?
  language        String?
  wordCount       Int?
  
  // Status
  status          String      @default("PENDING") // PENDING, COMPLETED, FAILED
  error           String?
  
  // Relations
  userId          String
  user            User        @relation("UserExtractions", fields: [userId], references: [id])
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
  @@index([url])
  @@index([createdAt])
  @@map("url_extractions")
}

// Phase 6 Full: Locale for i18n support
enum Locale {
  en
  ar
}

// Phase 6 Full: User & Role (expanded for RBAC)
enum Role {
  USER
  AUTHOR    // Can create and edit own posts, submit for review
  REVIEWER  // Can approve/reject posts
  EDITOR    // Can edit any post and publish
  OWNER     // Full access (site owner)
  ADMIN     // Full access (admin)
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts           Post[]          @relation("UserPosts")
  audits          Audit[]         @relation("UserAudits")
  uploadedMedia   MediaAsset[]    @relation("UploadedMedia")     // Phase 6.5
  aiGenerations   AIGeneration[]  @relation("UserGenerations")   // Phase 7
  urlExtractions  URLExtraction[] @relation("UserExtractions")   // Phase 7
  caseStudies     CaseStudy[]     @relation("UserCaseStudies")   // Phase 1
  linkedInPosts   LinkedInPost[]  @relation("UserLinkedInPosts") // LinkedIn

  @@map("users")
}

// Phase 6 Full: Post (multilingual with translations)
enum PostStatus {
  DRAFT
  PUBLISHED
}

model Post {
  id          String      @id @default(cuid())
  // NOTE: title, slug, excerpt, content moved to PostTranslation
  // Keeping these fields temporarily for backwards compatibility during migration
  title       String      // TODO: Remove after backfill
  slug        String      @unique // TODO: Remove after backfill
  excerpt     String?     // TODO: Remove after backfill
  content     String      // TODO: Remove after backfill
  
  status      PostStatus  @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  authorId    String
  author      User        @relation("UserPosts", fields: [authorId], references: [id])

  // Phase 6.5: Featured image support
  featuredImageId String?
  featuredImage   MediaAsset? @relation("FeaturedImage", fields: [featuredImageId], references: [id])

  translations    PostTranslation[] // Phase 6 Full: i18n support
  PostMedia       PostMedia[]
  aiGenerations   AIGeneration[]    @relation("PostGenerations")     // Phase 7
  linkedInPosts   LinkedInPost[]    @relation("LinkedInFromBlogPost") // LinkedIn posts generated from this blog

  @@map("posts")
}

// Phase 6 Full: Post translations for multilingual content
model PostTranslation {
  id        String   @id @default(cuid())
  postId    String
  locale    Locale
  title     String
  slug      String
  excerpt   String?
  content   String   // markdown or serialized JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Ensure each post has only one translation per locale
  @@unique([postId, locale])
  // Ensure slugs are unique per locale
  @@unique([locale, slug])
  @@map("post_translations")
}

// Phase 6 Lite: Audit trail
model Audit {
  id        String   @id @default(cuid())
  entity    String   // "Post", "User", etc.
  entityId  String
  action    String   // "CREATE", "UPDATE", "PUBLISH", "DELETE"
  payload   Json?
  actorId   String?
  actor     User?    @relation("UserAudits", fields: [actorId], references: [id])
  createdAt DateTime @default(now())

  @@map("audits")
}

// Phase 1: Enhanced Lead model (Mini-CRM Light)
enum LeadInterest {
  COLLABORATION
  SPEAKING
  REFERRAL
  PRESS
  GENERAL
}

enum LeadSource {
  CONTACT_FORM
  LINKEDIN_EMBED
  NEWSLETTER
  MANUAL
}

enum LeadStatus {
  NEW
  REPLIED
  SCHEDULED
  ARCHIVED
}

model Lead {
  id            String       @id @default(cuid())
  
  // Contact Info
  name          String
  email         String
  organization  String?
  country       String?
  
  // Intent
  interest      LeadInterest
  message       String       @db.Text
  source        LeadSource
  
  // Management
  status        LeadStatus   @default(NEW)
  tags          String[]     @default([])
  nextActionAt  DateTime?
  
  // Metadata
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Auto-purge after 12 months
  expiresAt     DateTime?
  
  @@index([status, createdAt])
  @@index([email])
  @@map("leads")
}

model JobRun {
  id          String   @id @default(cuid())
  type        String   // "content_generation", "seo_analysis", etc.
  status      String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  input       Json?
  output      Json?
  error       String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("job_runs")
}

// Phase 8 Full: Social Media Embeds
model SocialEmbed {
  id        String   @id @default(cuid())
  key       String   @unique            // e.g. "LINKEDIN_WALL"
  html      String                      // sanitized embed HTML
  enabled   Boolean  @default(true)
  updatedBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("social_embeds")
}

// CMS: Hero Rotating Titles
model HeroTitle {
  id        String   @id @default(cuid())
  titleEn   String   // English title
  titleAr   String   // Arabic title
  order     Int      @default(0)
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hero_titles")
}

// CMS: Professional Experience
model Experience {
  id          String              @id @default(cuid())
  company     String
  role        String
  startDate   String              // e.g., "2019"
  endDate     String?             // e.g., "2023" or null for "Present"
  description String              // Rich text/HTML
  order       Int                 @default(0)
  enabled     Boolean             @default(true)
  logoUrl     String?             // Company logo
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  images      ExperienceImage[]

  @@map("experiences")
}

// CMS: Experience Images (landmarks, offices, etc.)
model ExperienceImage {
  id           String     @id @default(cuid())
  experienceId String
  url          String     // Image URL
  caption      String?    // Optional caption
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  experience   Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)

  @@map("experience_images")
}

// CMS: Hero Media (Video or Image)
model HeroMedia {
  id          String   @id @default(cuid())
  type        String   // "IMAGE" or "VIDEO"
  imageUrl    String?  // Hero image URL
  videoUrl    String?  // YouTube/Vimeo URL or self-hosted
  videoType   String?  // "youtube", "vimeo", "selfhosted"
  enabled     Boolean  @default(true)
  autoplay    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("hero_media")
}

// Phase 1: Newsletter Subscribers
model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("newsletter_signup")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([email])
  @@map("subscribers")
}

// Phase 1: Case Studies (Portfolio)
enum CaseStudyType {
  LITIGATION
  ARBITRATION
  ADVISORY
  VENTURE
}

model CaseStudy {
  id            String        @id @default(cuid())
  
  // Classification
  type          CaseStudyType
  confidential  Boolean       @default(false)
  
  // Content (Problem â†’ Strategy â†’ Outcome)
  title         String
  slug          String        @unique
  problem       String        @db.Text
  strategy      String        @db.Text
  outcome       String        @db.Text
  
  // Metadata
  categories    String[]      @default([])  // ["International Arbitration", "Conflict Prevention"]
  practiceArea  String?       // "Arbitration", "Litigation", etc.
  year          Int?
  jurisdiction  String?
  
  // Publishing
  published     Boolean       @default(false)
  publishedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  authorId      String
  author        User          @relation("UserCaseStudies", fields: [authorId], references: [id])
  
  // Media
  featuredImageId String?
  featuredImage   MediaAsset?  @relation("CaseStudyFeaturedImage", fields: [featuredImageId], references: [id])
  
  @@index([type, published])
  @@index([slug])
  @@map("case_studies")
}

// Phase 1: AI Provider Configuration
enum AIProvider {
  OPENAI
  ANTHROPIC
  COHERE
  CUSTOM
}

enum AIUseCase {
  CONTENT_GENERATION
  TRANSLATION
  EMAIL_MARKETING
  SEO_OPTIMIZATION
  CONTENT_IMPROVEMENT
  URL_EXTRACTION
}

model AIConfig {
  id          String       @id @default(cuid())
  
  // Provider Info
  provider    AIProvider
  name        String           // "OpenAI GPT-4", "Anthropic Claude 3.5"
  
  // Credentials
  apiKey      String           // Encrypted in production
  
  // Model Settings
  model       String           // "gpt-4-turbo", "claude-3-5-sonnet-20241022"
  
  // Use Cases (what this config is used for)
  useCases    AIUseCase[]      @default([])
  
  // Prompts
  systemPrompt String?         @db.Text
  
  // Status
  active      Boolean          @default(true)
  isDefault   Boolean          @default(false)
  
  // Metadata
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@index([provider, active])
  @@map("ai_configs")
}

// Phase 1: AI Prompt Templates (Saved Prompts)
model AIPromptTemplate {
  id          String     @id @default(cuid())
  
  // Template Info
  name        String           // "Arbitration Watch Digest"
  description String?          @db.Text
  category    String           // "arbitration", "conflict_prevention", "linkedin"
  
  // Prompt
  prompt      String           @db.Text
  
  // Settings
  useCase     AIUseCase
  tone        String?          // "professional", "casual", "technical"
  language    String?          // "en", "ar"
  
  // Usage
  usageCount  Int              @default(0)
  
  // Metadata
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@index([category])
  @@map("ai_prompt_templates")
}

// Site Logo Management
model SiteLogo {
  id        String   @id @default(cuid())
  url       String   // URL to logo image
  alt       String   @default("Khaled Aun")
  width     Int?
  height    Int?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("site_logos")
}

// LinkedIn Posts Management
model LinkedInPost {
  id          String   @id @default(cuid())
  
  // Content
  title       String
  content     String   @db.Text
  linkedinUrl String?  // URL to actual LinkedIn post
  
  // Status
  published   Boolean  @default(false)
  isPinned    Boolean  @default(false)
  
  // Author
  authorId    String
  author      User     @relation("UserLinkedInPosts", fields: [authorId], references: [id])
  
  // AI Generation
  aiGenerated Boolean  @default(false)
  aiGenerationId String?
  aiGeneration   AIGeneration? @relation("LinkedInPostGeneration", fields: [aiGenerationId], references: [id])
  
  // Source (if generated from blog post)
  sourcePostId String?
  sourcePost   Post?    @relation("LinkedInFromBlogPost", fields: [sourcePostId], references: [id])
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  
  @@index([published, isPinned])
  @@index([authorId])
  @@map("linkedin_posts")
}

// Sprint 1: AI Content Management System
model Topic {
  id              String    @id @default(uuid())
  title           String
  description     String?   @db.Text
  sourceUrl       String?   @map("source_url")
  sourceType      String?   @map("source_type")
  keywords        String[]  @default([])
  priority        Int       @default(0)
  status          String    @default("pending")
  locked          Boolean   @default(false)
  lockedAt        DateTime? @map("locked_at")
  lockedBy        String?   @map("locked_by")
  userNotes       String?   @db.Text @map("user_notes")
  relevanceScore  Float?    @map("relevance_score")
  scheduledFor    DateTime? @map("scheduled_for")
  metadata        Json?     @db.Json
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  content         ContentLibrary[]
  
  @@index([status, priority])
  @@index([locked])
  @@index([createdAt])
  @@map("topics")
}

model ContentLibrary {
  id                    String    @id @default(uuid())
  topicId               String?   @map("topic_id")
  type                  String
  format                String?
  title                 String
  content               String    @db.Text
  summary               String?   @db.Text
  excerpt               String?   @db.Text
  keywords              String[]  @default([])
  seoTitle              String?   @map("seo_title") @db.VarChar(100)
  seoDescription        String?   @map("seo_description") @db.VarChar(200)
  seoScore              Int?      @map("seo_score")
  wordCount             Int?      @map("word_count")
  readingTimeMinutes    Int?      @map("reading_time_minutes")
  status                String    @default("draft")
  publishedAt           DateTime? @map("published_at")
  publishedTo           String[]  @default([]) @map("published_to")
  linkedinPostId        String?   @map("linkedin_post_id")
  linkedinUrl           String?   @map("linkedin_url")
  blogPostId            String?   @map("blog_post_id")
  blogSlug              String?   @map("blog_slug")
  mediaIds              String[]  @default([]) @map("media_ids")
  featuredImageId       String?   @map("featured_image_id")
  tags                  String[]  @default([])
  category              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  lastEditedBy          String?   @map("last_edited_by")
  lastEditedAt          DateTime? @map("last_edited_at")
  scheduledFor          DateTime? @map("scheduled_for")
  authorId              String?   @map("author_id")
  metadata              Json?     @db.Json
  
  // Sprint 4: Publishing fields
  publishTargets        String[]  @default([]) @map("publish_targets") // ['linkedin', 'instagram']
  publishStatus         String    @default("draft") @map("publish_status") // draft, queued, posting, posted, failed
  publishedLinks        Json?     @default("{}") @map("published_links") @db.JsonB // {"linkedin": "https://..."}
  lastPublishError      String?   @map("last_publish_error") @db.Text
  publishAttempts       Int       @default(0) @map("publish_attempts")
  lastPublishAttempt    DateTime? @map("last_publish_attempt")
  
  // Sprint 5: Email notification fields
  emailNotificationSent       Boolean       @default(false) @map("email_notification_sent")
  emailNotificationSentAt     DateTime?     @map("email_notification_sent_at")
  emailNotificationCampaignId String?       @map("email_notification_campaign_id")
  emailCampaign               EmailCampaign? @relation("CampaignNotifications", fields: [emailNotificationCampaignId], references: [id], onDelete: SetNull)
  
  // Relations
  topic                 Topic?         @relation(fields: [topicId], references: [id], onDelete: SetNull)
  publishJobs           PublishJob[]
  
  @@index([status])
  @@index([type])
  @@index([topicId])
  @@index([publishedAt])
  @@index([scheduledFor])
  @@index([publishStatus])
  @@map("content_library")
}

model MediaLibrary {
  id                String    @id @default(uuid())
  filename          String
  originalFilename  String?   @map("original_filename")
  url               String
  thumbnailUrl      String?   @map("thumbnail_url")
  type              String
  sizeBytes         Int?      @map("size_bytes")
  mimeType          String?   @map("mime_type")
  width             Int?
  height            Int?
  durationSeconds   Int?      @map("duration_seconds")
  altText           String?   @map("alt_text")
  caption           String?
  tags              String[]  @default([])
  folder            String?   @default("uncategorized")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  uploadedBy        String?   @map("uploaded_by")
  usedInContent     String[]  @default([]) @map("used_in_content")
  metadata          Json?     @db.Json
  
  @@index([type])
  @@index([folder])
  @@index([createdAt])
  @@map("media_library")
}

// ============================================
// Sprint 4: Auth + LinkedIn Integration
// ============================================

// Social accounts for OAuth (LinkedIn, Instagram, etc.)
model SocialAccount {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  provider        String    // 'linkedin', 'instagram', etc.
  accountId       String    @map("account_id") // Provider's user ID
  accountName     String?   @map("account_name")
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  tokenExpiresAt  DateTime? @map("token_expires_at")
  scopes          String[]  @default([])
  metadata        Json?     @default("{}") @db.JsonB
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([userId, provider, accountId])
  @@index([userId])
  @@index([provider])
  @@index([isActive])
  @@map("social_accounts")
}

// Publish jobs for scheduler
model PublishJob {
  id           String    @id @default(uuid())
  contentId    String    @map("content_id")
  platform     String    // 'linkedin', 'instagram', etc.
  scheduledFor DateTime  @map("scheduled_for")
  status       String    @default("pending") // pending, processing, completed, failed
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3) @map("max_attempts")
  lastAttempt  DateTime? @map("last_attempt")
  lastError    String?   @map("last_error") @db.Text
  result       Json?     @db.JsonB // Success response
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  content      ContentLibrary @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([status])
  @@index([scheduledFor, status])
  @@map("publish_jobs")
}

// User roles for RBAC
model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      String   // 'admin', 'editor', 'viewer'
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")

  @@unique([userId, role])
  @@index([userId])
  @@index([role])
  @@map("user_roles")
}

// =====================================================
// Sprint 5: Email Marketing + CRM Models
// =====================================================

// Newsletter subscribers with full tracking
model NewsletterSubscriber {
  id        String  @id @default(uuid())
  email     String  @unique
  status    String  @default("pending") // pending, confirmed, unsubscribed, bounced, complained
  firstName String? @map("first_name")
  lastName  String? @map("last_name")

  // Subscription management
  subscribedAt     DateTime? @map("subscribed_at") @default(now())
  confirmedAt      DateTime? @map("confirmed_at")
  unsubscribedAt   DateTime? @map("unsubscribed_at")

  // Double opt-in
  confirmationToken          String?   @unique @map("confirmation_token")
  confirmationTokenExpiresAt DateTime? @map("confirmation_token_expires_at")

  // Preferences
  preferences Json? @default("{\"blog\": true, \"newsletter\": true, \"product_updates\": false}") @db.JsonB

  // Source tracking
  source      String? // 'website', 'linkedin', 'manual', 'import'
  sourceUrl   String? @map("source_url")
  utmSource   String? @map("utm_source")
  utmMedium   String? @map("utm_medium")
  utmCampaign String? @map("utm_campaign")

  // Engagement metrics
  totalOpens     Int       @default(0) @map("total_opens")
  totalClicks    Int       @default(0) @map("total_clicks")
  lastOpenedAt   DateTime? @map("last_opened_at")
  lastClickedAt  DateTime? @map("last_clicked_at")

  // CRM sync
  hubspotContactId String?   @map("hubspot_contact_id")
  hubspotSyncedAt  DateTime? @map("hubspot_synced_at")

  // Metadata
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  tags         String[]  @default([])
  customFields Json?     @default("{}") @db.JsonB @map("custom_fields")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  emailEvents EmailEvent[]

  @@index([email])
  @@index([status])
  @@index([confirmationToken])
  @@index([hubspotContactId])
  @@index([createdAt(sort: Desc)])
  @@map("newsletter_subscribers")
}

// Email campaigns
model EmailCampaign {
  id String @id @default(uuid())

  // Campaign details
  name        String
  subject     String
  previewText String? @map("preview_text")
  fromName    String  @default("Khaled Aun") @map("from_name")
  fromEmail   String  @default("hello@khaledaun.com") @map("from_email")
  replyTo     String  @default("hello@khaledaun.com") @map("reply_to")

  // Content
  contentHtml String @map("content_html")
  contentText String? @map("content_text")

  // Scheduling
  status       String    @default("draft") // draft, scheduled, sending, sent, failed
  scheduledFor DateTime? @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")

  // Targeting
  targetStatus  String[] @default(["confirmed"]) @map("target_status")
  targetTags    String[] @default([]) @map("target_tags")
  excludeTags   String[] @default([]) @map("exclude_tags")

  // Email provider
  provider           String  @default("resend") // resend, manual
  providerCampaignId String? @map("provider_campaign_id")
  providerResponse   Json?   @db.JsonB @map("provider_response")

  // Analytics
  totalRecipients   Int @default(0) @map("total_recipients")
  totalSent         Int @default(0) @map("total_sent")
  totalDelivered    Int @default(0) @map("total_delivered")
  totalOpens        Int @default(0) @map("total_opens")
  totalClicks       Int @default(0) @map("total_clicks")
  totalBounces      Int @default(0) @map("total_bounces")
  totalComplaints   Int @default(0) @map("total_complaints")
  totalUnsubscribes Int @default(0) @map("total_unsubscribes")

  // Metadata
  createdBy String?   @map("created_by")
  tags      String[]  @default([])
  notes     String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  emailEvents EmailEvent[]
  contentNotifications ContentLibrary[] @relation("CampaignNotifications")

  @@index([status])
  @@index([scheduledFor])
  @@index([sentAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("email_campaigns")
}

// Email events (analytics)
model EmailEvent {
  id String @id @default(uuid())

  // Relationships
  campaignId   String?              @map("campaign_id")
  campaign     EmailCampaign?       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  subscriberId String?              @map("subscriber_id")
  subscriber   NewsletterSubscriber? @relation(fields: [subscriberId], references: [id], onDelete: SetNull)
  email        String

  // Event details
  eventType String @map("event_type") // sent, delivered, opened, clicked, bounced, complained, unsubscribed

  // Click tracking
  linkUrl  String? @map("link_url")
  linkText String? @map("link_text")

  // Bounce/complaint details
  bounceType             String? @map("bounce_type") // hard, soft
  bounceReason           String? @map("bounce_reason")
  complaintFeedbackType  String? @map("complaint_feedback_type")

  // Provider details
  provider          String  @default("resend")
  providerMessageId String? @map("provider_message_id")
  providerEventId   String? @map("provider_event_id")

  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")
  location  Json?   @db.JsonB // {country, city, region}

  // Timestamps
  eventTimestamp DateTime @default(now()) @map("event_timestamp")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@index([subscriberId])
  @@index([email])
  @@index([eventType])
  @@index([eventTimestamp(sort: Desc)])
  @@index([providerMessageId])
  @@map("email_events")
}

// CRM leads (HubSpot)
model CrmLead {
  id String @id @default(uuid())

  // Contact info
  email     String
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  company   String?
  jobTitle  String? @map("job_title")
  phone     String?
  website   String?

  // Lead details
  source      String  // contact_form, newsletter, linkedin, manual
  sourceUrl   String? @map("source_url")
  message     String?
  leadStatus  String  @default("new") @map("lead_status") // new, contacted, qualified, unqualified, converted

  // UTM tracking
  utmSource   String? @map("utm_source")
  utmMedium   String? @map("utm_medium")
  utmCampaign String? @map("utm_campaign")
  utmTerm     String? @map("utm_term")
  utmContent  String? @map("utm_content")

  // HubSpot sync
  hubspotContactId String?   @unique @map("hubspot_contact_id")
  hubspotDealId    String?   @map("hubspot_deal_id")
  hubspotSyncedAt  DateTime? @map("hubspot_synced_at")
  hubspotSyncStatus String   @default("pending") @map("hubspot_sync_status") // pending, synced, failed
  hubspotSyncError String?   @map("hubspot_sync_error")

  // Metadata
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  referrer     String?
  customFields Json?     @default("{}") @db.JsonB @map("custom_fields")
  tags         String[]  @default([])

  // Follow-up
  assignedTo        String?   @map("assigned_to")
  notes             String?
  lastContactedAt   DateTime? @map("last_contacted_at")
  nextFollowUpAt    DateTime? @map("next_follow_up_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([leadStatus])
  @@index([source])
  @@index([hubspotContactId])
  @@index([hubspotSyncStatus])
  @@index([createdAt(sort: Desc)])
  @@map("crm_leads")
}

// Email templates
model EmailTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    String? // newsletter, transactional, marketing, automated

  // Content
  subject     String
  previewText String? @map("preview_text")
  contentHtml String  @map("content_html")
  contentText String? @map("content_text")

  // Variables
  variables Json? @default("[]") @db.JsonB // [{name, required, default}]

  // Metadata
  isActive   Boolean   @default(true) @map("is_active")
  usageCount Int       @default(0) @map("usage_count")
  lastUsedAt DateTime? @map("last_used_at")

  createdBy String?   @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@map("email_templates")
}